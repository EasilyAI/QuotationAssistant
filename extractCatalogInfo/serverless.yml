service: hb-file-processing

frameworkVersion: "3"

plugins:
  - serverless-offline
  - serverless-python-requirements

package:
  individually: false
  patterns:
    - '!node_modules/**'
    - '!__pycache__/**'
    - '!.pytest_cache/**'
    - '!tests/**'

custom:
  # Single environment (no -dev / -prod suffixes)
  # Bucket name must be globally unique, so we add the AWS account ID
  uploadBucket: hb-files-raw
  filesTable: hb-files
  catalogProductsTable: hb-catalog-products
  productsTable: hb-products
  priceListProductsTable: hb-pricelist-products

provider:
  name: aws
  runtime: python3.11
  region: us-east-1
  stage: dev                 # internal only, not used in resource names
  profile: hb-client
  deploymentBucket:
    name: hb-file-processing-deployment-bucket
    blockPublicAccess: true

  httpApi:
    cors:
      allowedOrigins:
        - "*"  # TODO: Replace with specific origins in production (e.g., ["http://localhost:3000", "https://yourdomain.com"])
      allowedHeaders:
        - Content-Type
        - Authorization
        - X-Requested-With
        - X-Amz-Date
        - X-Api-Key
        - X-Amz-Security-Token
      allowedMethods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      allowCredentials: false
      maxAge: 3600
      exposedResponseHeaders:
        - Content-Type
        - X-Amz-Date
        - X-Amz-Request-Id

  environment:
    UPLOAD_BUCKET: ${self:custom.uploadBucket}
    FILES_TABLE: ${self:custom.filesTable}
    CATALOG_PRODUCTS_TABLE: ${self:custom.catalogProductsTable}
    PRODUCTS_TABLE: ${self:custom.productsTable}
    PRICE_LIST_PRODUCTS_TABLE: ${self:custom.priceListProductsTable}

  iamRoleStatements:
    # S3 access for generating presigned URLs and accessing uploaded files
    - Effect: Allow
      Action:
        - s3:PutObject
        - s3:GetObject
        - s3:DeleteObject
        - s3:ListBucket
      Resource:
        - arn:aws:s3:::${self:custom.uploadBucket}
        - arn:aws:s3:::${self:custom.uploadBucket}/*

    # DynamoDB access for Files, CatalogProducts, Products, and PriceListProducts tables
    - Effect: Allow
      Action:
        - dynamodb:PutItem
        - dynamodb:GetItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
        - dynamodb:Query
        - dynamodb:Scan
        - dynamodb:BatchGetItem
        - dynamodb:BatchWriteItem
      Resource:
        - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.filesTable}
        - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.catalogProductsTable}
        - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.productsTable}
        - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.productsTable}/index/*
        - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.priceListProductsTable}

    # Textract permissions (for PDFs)
    - Effect: Allow
      Action:
        - textract:StartDocumentAnalysis
        - textract:GetDocumentAnalysis
      Resource: "*"

functions:
  # HTTP API for UI -> get presigned URL to upload file to S3
  getPresignedUrl:
    handler: src/get_presigned_url.get_presigned_url
    events:
      - httpApi:
          path: /api/files/presigned-url
          method: post

  # HTTP API for UI -> generate presigned download URL (client supplies S3 key)
  getFileDownloadUrl:
    handler: src/get_files.get_file_download_url
    events:
      - httpApi:
          path: /api/files/download-url
          method: post
          
  # HTTP API for UI -> get file information after upload
  getFileInfo:
    handler: src/get_files.get_file_info
    events:
      - httpApi:
          path: /api/files/{fileId}
          method: get

  # HTTP API for UI -> get all files
  getFiles:
    handler: src/get_files.get_files
    events:
      - httpApi:
          path: /api/files
          method: get

  
  # HTTP API for UI -> delete a file
  deleteFile:
    handler: src/get_files.delete_file
    events:
      - httpApi:
          path: /api/files/{fileId}
          method: delete


  # HTTP API for UI -> get catalog products extracted from a file
  getCatalogProducts:
    handler: src/get_files.get_catalog_products
    events:
      - httpApi:
          path: /api/files/{fileId}/catalog-products
          method: get

  # HTTP API for UI -> get price list products extracted from a file
  getPriceListProducts:
    handler: src/get_files.get_price_list_products
    events:
      - httpApi:
          path: /api/files/{fileId}/price-list-products
          method: get

  # HTTP API for UI -> update catalog products after review
  updateCatalogProducts:
    handler: src/get_files.update_catalog_products
    events:
      - httpApi:
          path: /api/files/{fileId}/catalog-products
          method: put

  # HTTP API for UI -> update price list products after review
  updatePriceListProducts:
    handler: src/get_files.update_price_list_products
    timeout: 25  # Extended timeout for large price list updates (5558 products)
    events:
      - httpApi:
          path: /api/files/{fileId}/price-list-products
          method: put

  # HTTP API for UI -> check if a file already exists
  checkFileExists:
    handler: src/get_files.check_file_exists
    events:
      - httpApi:
          path: /api/files/check-file-exists
          method: post

  # HTTP API for UI -> complete file review (mark as completed)
  completeFileReview:
    handler: src/get_files.complete_file_review
    events:
      - httpApi:
          path: /api/files/{fileId}/complete
          method: put

  # HTTP API for UI -> check existing products by ordering numbers
  checkExistingProducts:
    handler: src/get_files.check_existing_products
    events:
      - httpApi:
          path: /api/products/check-existing
          method: post

  # HTTP API for UI -> save products from catalog to products table
  saveProductsFromCatalog:
    handler: src/get_files.save_products_from_catalog
    events:
      - httpApi:
          path: /api/products/from-catalog
          method: post

  # HTTP API for UI -> save products from price list to products table
  saveProductsFromPriceList:
    handler: src/get_files.save_products_from_price_list
    timeout: 120  # Extended timeout for saving thousands of products with batch writes
    events:
      - httpApi:
          path: /api/products/from-price-list
          method: post

  listProducts:
    handler: src/get_files.list_products
    events:
      - httpApi:
          path: /api/products
          method: get

  # Triggered whenever a file is uploaded to the bucket (via presigned URL)
  # Note: S3 event is configured manually on the existing bucket to avoid CloudFormation import issues
  processUploadedFile:
    handler: src/process_upload_file.process_uploaded_file
    timeout: 45  # 5 minutes for Textract processing
    # S3 event configured manually - see setup instructions
    # events:
    #   - s3:
    #       bucket: ${self:custom.uploadBucket}
    #       event: s3:ObjectCreated:*

resources:
  Resources:
    # UploadBucket: # bucket already exists, so we reference it by name only
    # CORS is configured manually via AWS CLI (see setup instructions)
    # UploadBucket:
    #   Type: AWS::S3::Bucket
    #   Properties:
    #     BucketName: ${self:custom.uploadBucket}
    #     CorsConfiguration:
    #       CorsRules:
    #         - AllowedOrigins:
    #             - "*"  # TODO: Replace with specific origins in production
    #           AllowedHeaders:
    #             - "*"
    #           AllowedMethods:
    #             - GET
    #             - PUT
    #             - POST
    #             - HEAD
    #           MaxAge: 3000

    FilesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.filesTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: fileId
            AttributeType: S
        KeySchema:
          - AttributeName: fileId
            KeyType: HASH

    CatalogProductsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.catalogProductsTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: fileId
            AttributeType: S
        KeySchema:
          - AttributeName: fileId
            KeyType: HASH

    ProductsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.productsTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: orderingNumber
            AttributeType: S
          - AttributeName: productCategory
            AttributeType: S
        KeySchema:
          - AttributeName: orderingNumber
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: ProductCategoryIndex
            KeySchema:
              - AttributeName: productCategory
                KeyType: HASH
            Projection:
              ProjectionType: ALL
              
    PriceListProductsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.priceListProductsTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: fileId
            AttributeType: S
          - AttributeName: chunkIndex
            AttributeType: N
        KeySchema:
          - AttributeName: fileId
            KeyType: HASH
          - AttributeName: chunkIndex
            KeyType: RANGE
