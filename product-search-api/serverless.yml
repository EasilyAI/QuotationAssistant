service: product-search-service

frameworkVersion: '3'

# Load variables from local .env / .env.* files so ${env:...} works in all commands
useDotenv: true

provider:
  name: aws
  runtime: python3.11
  architecture: x86_64
  region: ${opt:region, 'us-east-1'}
  stage: ${opt:stage, 'dev'}
  memorySize: 512  # Lightweight - Bedrock embeddings via API
  timeout: 30
  
  httpApi:
    cors:
      allowedOrigins:
        - "http://localhost:3000"
        - "http://localhost:3001"
        - "${self:custom.productionFrontendUrl}"
      allowedHeaders:
        - Content-Type
        - Authorization
        - X-Requested-With
        - X-Amz-Date
        - X-Api-Key
        - X-Amz-Security-Token
      allowedMethods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      allowCredentials: true  # Required for Cognito tokens
      maxAge: 3600
    # JWT Authorizer (built-in, simpler than Lambda authorizer)
    authorizers:
      cognitoAuthorizer:
        identitySource: $request.header.Authorization
        issuerUrl: https://cognito-idp.${self:provider.region}.amazonaws.com/${env:COGNITO_USER_POOL_ID}
        audience:
          - ${env:COGNITO_APP_CLIENT_ID}
  
  environment:
    # Ensure local/offline Python can locate service packages
    PYTHONPATH: ${env:PYTHONPATH, './'}
    # Qdrant Cloud Configuration
    QDRANT_URL: ${env:QDRANT_URL}
    QDRANT_API_KEY: ${env:QDRANT_API_KEY}
    QDRANT_COLLECTION: products
    
    # Embedding Model Configuration (AWS Bedrock - NO Docker needed!)
    EMBEDDING_MODEL: amazon.titan-embed-text-v1
    VECTOR_SIZE: 1536
    
    # Optional: OpenAI API Key (if using OpenAI embeddings)
    # OPENAI_API_KEY: ${env:OPENAI_API_KEY, ''}
    
    # DynamoDB Configuration
    PRODUCT_TABLE: ${self:custom.productsTable}
    CATALOG_PRODUCTS_TABLE: ${self:custom.catalogProductsTable}
    PRICE_LIST_PRODUCTS_TABLE: ${self:custom.priceListProductsTable}
    
    # Logging
    LOG_LEVEL: INFO
    
    # Relevance Level Thresholds (configurable)
    RELEVANCE_HIGH_THRESHOLD: ${env:RELEVANCE_HIGH_THRESHOLD, '0.70'}
    RELEVANCE_MEDIUM_THRESHOLD: ${env:RELEVANCE_MEDIUM_THRESHOLD, '0.50'}
    
    # Cognito Configuration (optional - for JWT authorizer)
    COGNITO_USER_POOL_ID: ${env:COGNITO_USER_POOL_ID, ''}
    COGNITO_APP_CLIENT_ID: ${env:COGNITO_APP_CLIENT_ID, ''}
    COGNITO_REGION: ${env:COGNITO_REGION, 'us-east-1'}
  
  iam:
    role:
      statements:
        # DynamoDB permissions (read-only for stream)
        - Effect: Allow
          Action:
            - dynamodb:GetItem
            - dynamodb:Scan
            - dynamodb:DescribeStream
            - dynamodb:GetRecords
            - dynamodb:GetShardIterator
            - dynamodb:ListStreams
          Resource:
            - arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/${self:custom.productsTable}
            - arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/${self:custom.productsTable}/stream/*
        - Effect: Allow
          Action:
            - dynamodb:GetItem
            - dynamodb:Query
          Resource:
            - arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/${self:custom.catalogProductsTable}
            - arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/${self:custom.priceListProductsTable}
        
        # AWS Bedrock permissions (for embeddings - NO Docker needed!)
        - Effect: Allow
          Action:
            - bedrock:InvokeModel
          Resource:
            - arn:aws:bedrock:*:*:foundation-model/amazon.titan-embed-text-v1
            - arn:aws:bedrock:*:*:foundation-model/cohere.embed-english-v3
        
        # CloudWatch Logs
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: '*'
        
        # Secrets Manager access for API keys
        - Effect: Allow
          Action:
            - secretsmanager:GetSecretValue
            - secretsmanager:DescribeSecret
          Resource:
            - arn:aws:secretsmanager:${aws:region}:${aws:accountId}:secret:product-search-api-key-*
            - arn:aws:secretsmanager:${aws:region}:${aws:accountId}:secret:qdrant-api-key-*
            - arn:aws:secretsmanager:${aws:region}:${aws:accountId}:secret:file-ingestion-api-key-*
            - arn:aws:secretsmanager:${aws:region}:${aws:accountId}:secret:quotation-api-key-*

custom:
  uploadBucket: hb-files-raw
  filesTable: hb-files
  catalogProductsTable: hb-catalog-products
  productsTable: hb-products
  priceListProductsTable: hb-pricelist-products
  # Production frontend URL (change this when deploying to production)
  productionFrontendUrl: ${env:PRODUCTION_FRONTEND_URL, 'https://catalog-searcher-omers-projects-e3a112ba.vercel.app'}
  serverless-offline:
    httpPort: 3000
    lambdaPort: 3002
    useChildProcesses: true
    noPrependStageInUrl: true
  pythonRequirements:
    # Build deps into a Lambda layer (Linux wheels) and keep function zips small
    layer: true
    requirementsFile: layer/requirements.txt
    dockerizePip: false
    pipCmdExtraArgs:
      - "--platform"
      - "manylinux2014_x86_64"
      - "--only-binary"
      - ":all:"
      - "--implementation"
      - "cp"
      - "--python-version"
      - "3.11"
      - "--abi"
      - "cp311"
    slim: false
    strip: false
    zip: true
    invalidateCaches: true
    useDownloadCache: false
    useStaticCache: false
    # Use the explicit pyenv path so packaging always runs with Python 3.11
    pythonBin: "/Users/omerlewinsky/.pyenv/versions/3.11.9/bin/python3.11"
    noDeploy:
      - boto3
      - botocore
      - docutils
      - jmespath
      - pip
      - python-dateutil
      - s3transfer
      - setuptools
      - six
      - urllib3

functions:
  searchIndexer:
    handler: indexer/handler.handler
    description: Indexes products into Qdrant from DynamoDB Stream (using Bedrock embeddings)
    memorySize: 512
    timeout: 60
    layers:
      - { Ref: PythonRequirementsLambdaLayer }
    events:
      - stream:
          type: dynamodb
          arn:
            Fn::ImportValue: hb-file-processing-${self:provider.stage}-products-table-stream-arn
          batchSize: 10
          startingPosition: LATEST
          maximumRetryAttempts: 3
          enabled: true

  searchApi:
    handler: api/handler.handler
    description: Search API for vector search and autocomplete (using Bedrock embeddings)
    memorySize: 512
    timeout: 30
    layers:
      - { Ref: PythonRequirementsLambdaLayer }
    events:
      - httpApi:
          path: /search
          method: get
      - httpApi:
          path: /autocomplete
          method: get
      - httpApi:
          path: /product
          method: get
      - httpApi:
          path: /product/{orderingNumber}
          method: get
      - httpApi:
          path: /batch-search
          method: post

plugins:
  - serverless-python-requirements
  - serverless-offline

package:
  individually: false
  patterns:
    - '!node_modules/**'
    - '!.venv/**'
    - '!__pycache__/**'
    - '!*.pyc'
    - '!.pytest_cache/**'
    - '!tests/**'
    - '!.serverless/**'
    - '!.git/**'
    - '!.env'
    - '!.env.*'
    - '!*.md'
    - '!scripts/**'
    - '!documentation/**'
    - 'indexer/**'
    - 'api/**'
    - 'schemas/**'
    - '../shared/**'

resources:
  Outputs:
    SearchApiUrl:
      Description: Search API URL
      Value:
        Fn::Sub: https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com
      Export:
        Name: ${self:service}-${self:provider.stage}-api-url
    
    QdrantCollection:
      Description: Qdrant Collection Name
      Value: ${self:provider.environment.QDRANT_COLLECTION}
      Export:
        Name: ${self:service}-${self:provider.stage}-qdrant-collection
